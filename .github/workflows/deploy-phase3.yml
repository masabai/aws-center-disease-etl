name: Deploy Phase III - CDC Spark Orchestrator
on:
  push:
    # Adding both branches here ensures the same code works everywhere
    branches: [ master, stable ]
    paths: 
      - 'phase3-spark-aws-serverless/**'
      - 'phase2-pandas-aws-hybrid/lambdas/**' 
  workflow_dispatch: {} 

permissions:
  id-token: write
  contents: read

jobs:
  deploy-and-orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActionsSync
          aws-region: us-west-2

      # 1. Update the Spark Script in the Glue Asset Bucket
      - name: Sync Glue Script
        run: |
          aws s3 cp ./phase3-spark-aws-serverless/glue/glue_job.py s3://aws-glue-assets-008878757943-us-west-2/scripts/cdc_glue_transform_chronic_heart.py --region us-west-2

      # 2. Update Lambda Functions (Extract, Load)
      - name: Update Lambda Code
        run: |
          # Package and update the Extract Lambda (Shared)
          zip -j extract.zip ./phase2-pandas-aws-hybrid/lambdas/extract_cdc/*.py
          aws lambda update-function-code \
            --function-name extract_cdc \
            --zip-file fileb://extract.zip \
            --region us-west-2
          
          # Package and update the Redshift Load Lambda
          # Explicit --region prevents "ResourceNotFoundException" on branch switches
          zip -j load.zip ./phase3-spark-aws-serverless/lambdas/lambda_function.py
          aws lambda update-function-code \
            --function-name lambda_function \
            --zip-file fileb://load.zip \
            --region us-west-2

      # 3. Trigger the Orchestrated Pipeline
      - name: Execute State Machine
        run: |
          aws stepfunctions start-execution \
            --state-machine-arn arn:aws:states:us-west-2:008878757943:stateMachine:CDC_ETL_SPARK_Pipeline \
            --region us-west-2
